<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>t560</title>
    <link rel="icon" type="image/svg+xml" href="/robot.svg" />
    <style>
      :root {
        --bg0: #071216;
        --bg1: #0a1e23;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.09);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.62);
        --accent: #00e6d3;
        --accent2: #00b3a4;
        --danger: #ff4d4d;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--text);
        background: radial-gradient(1100px 700px at 15% 10%, rgba(0, 230, 211, 0.12), transparent 55%),
          radial-gradient(900px 600px at 75% 20%, rgba(0, 179, 164, 0.10), transparent 60%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        min-height: 100vh;
      }
      header {
        padding: 18px 18px 10px;
        display: flex;
        gap: 12px;
        align-items: baseline;
        justify-content: space-between;
      }
      .nav {
        display: flex;
        gap: 10px;
        align-items: baseline;
      }
      .nav a {
        font-family: var(--mono);
        font-size: 12px;
        color: rgba(255, 255, 255, 0.78);
        text-decoration: none;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.16);
      }
      .nav a:hover {
        border-color: rgba(0, 230, 211, 0.35);
        color: var(--text);
      }
      .brand {
        display: flex;
        align-items: baseline;
        gap: 10px;
      }
      .brand img {
        width: 22px;
        height: 22px;
        display: block;
      }
      .brand h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.3px;
      }
      .brand .tag {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 0 18px 18px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }
      .panel .bar {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.14);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .bar .left {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.22);
      }
      .dot.ok {
        background: var(--accent2);
      }
      .dot.bad {
        background: var(--danger);
      }
      .bar .title {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
      }
      .bar .right {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      input,
      button,
      textarea {
        font: inherit;
      }
      .tokenRow {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .tokenRow input {
        width: 240px;
        padding: 8px 10px;
        border-radius: 10px;
        background: var(--panel2);
        border: 1px solid rgba(255, 255, 255, 0.10);
        color: var(--text);
        font-family: var(--mono);
        font-size: 12px;
      }
      .tokenRow button {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(0, 230, 211, 0.10);
        color: var(--text);
        cursor: pointer;
      }
      .chat {
        height: calc(100vh - 220px);
        min-height: 420px;
        display: flex;
        flex-direction: column;
      }
      .messages {
        flex: 1;
        overflow: auto;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .msg {
        max-width: 78%;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.06);
        white-space: pre-wrap;
        line-height: 1.35;
      }
      .msg.user {
        align-self: flex-end;
        border-color: rgba(0, 230, 211, 0.30);
        background: rgba(0, 230, 211, 0.08);
      }
      .msg.assistant {
        align-self: flex-start;
      }
      .composer {
        display: flex;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.12);
      }
      .composer textarea {
        flex: 1;
        resize: none;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.10);
        color: var(--text);
        outline: none;
      }
      .composer button {
        width: 120px;
        border-radius: 12px;
        border: 1px solid rgba(0, 230, 211, 0.35);
        background: linear-gradient(180deg, rgba(0, 230, 211, 0.20), rgba(0, 179, 164, 0.18));
        color: var(--text);
        cursor: pointer;
      }
      .composer button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
        font-family: var(--mono);
      }
      @media (max-width: 720px) {
        .msg {
          max-width: 92%;
        }
        .tokenRow input {
          width: 180px;
        }
        .composer button {
          width: 92px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <img src="/robot.svg" alt="t560" />
        <h1>t560</h1>
        <div class="tag">gateway</div>
      </div>
      <div class="nav">
        <a href="/deploy.html">deploy</a>
        <div class="hint" id="statusText">disconnected</div>
      </div>
    </header>

    <div class="wrap">
      <div class="panel">
        <div class="bar">
          <div class="left">
            <div class="dot bad" id="dot"></div>
            <div class="title">WebChat</div>
          </div>
          <div class="right tokenRow">
            <input id="token" placeholder="gateway token or password" autocomplete="off" />
            <button id="saveToken">Save</button>
          </div>
        </div>
        <div class="chat">
          <div class="messages" id="messages"></div>
          <div class="composer">
            <textarea id="input" rows="2" placeholder="Message t560..."></textarea>
            <button id="send">Send</button>
          </div>
        </div>
      </div>
      <div class="hint">
        Tip: if auth is enabled, enter the gateway token (or password) created during deploy.
      </div>
      <div class="hint">
        Need to deploy first? Open <a href="/deploy.html">Deploy t560</a>.
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const messagesEl = $("messages");
      const inputEl = $("input");
      const sendBtn = $("send");
      const tokenEl = $("token");
      const saveTokenBtn = $("saveToken");
      const dotEl = $("dot");
      const statusText = $("statusText");

      const storageKey = "t560.gateway.token.v1";
      tokenEl.value = localStorage.getItem(storageKey) || "";
      saveTokenBtn.onclick = () => {
        localStorage.setItem(storageKey, tokenEl.value.trim());
        connect();
      };

      let ws = null;
      let connected = false;

      function addMsg(role, text) {
        const div = document.createElement("div");
        div.className = "msg " + role;
        div.textContent = text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function setStatus(ok, text) {
        connected = ok;
        dotEl.className = "dot " + (ok ? "ok" : "bad");
        statusText.textContent = text;
        sendBtn.disabled = !ok;
      }

      function connect() {
        if (ws) {
          try { ws.close(); } catch {}
        }
        const token = (tokenEl.value || "").trim();
        const url = new URL(location.origin.replace("http", "ws") + "/ws");
        if (token) url.searchParams.set("token", token);
        url.searchParams.set("session", "webchat");
        ws = new WebSocket(url.toString());
        setStatus(false, "connecting...");

        ws.onopen = () => setStatus(true, "connected");
        ws.onclose = () => setStatus(false, "disconnected");
        ws.onerror = () => setStatus(false, "error");
        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            if (msg.type === "history") {
              messagesEl.textContent = "";
              for (const m of msg.messages || []) {
                addMsg(m.role, m.content);
              }
              return;
            }
            if (msg.type === "message") {
              addMsg(msg.role, msg.content);
              return;
            }
            if (msg.type === "error") {
              addMsg("assistant", "[error] " + msg.message);
              return;
            }
          } catch {
            addMsg("assistant", String(ev.data));
          }
        };
      }

      async function send() {
        const text = (inputEl.value || "").trim();
        if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
        inputEl.value = "";
        ws.send(JSON.stringify({ type: "user_message", content: text }));
      }

      sendBtn.onclick = send;
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });

      connect();
    </script>
  </body>
</html>
